<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clean Water Detector â€” Enhanced (Calm & Clean)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#eaf9ff; --accent:#4db8ff; --accent-dark:#045c9c; --text:#033e6b;
  --clean-blue:#3fb0ff; --dirty-red:#ff6b6b; --maybe-yellow:#f0c419;
  --fish-count:28; /* default number of fish in background */
  --caustics-opacity:0.18;
}

/* Reset & layout */
html,body{height:100%;margin:0;background:var(--bg);font-family:'Inter',sans-serif;color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:980px;margin:32px auto;padding:0 20px;position:relative;z-index:6}
header{display:flex;align-items:center;gap:12px;justify-content:center;padding:28px 12px;background:rgba(255,255,255,0.92);border-radius:12px;box-shadow:0 6px 18px rgba(9,30,63,0.06);position:relative;z-index:6}
.logo{width:62px;height:62px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#bfe9ff);display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 6px 14px rgba(0,0,0,0.06)}
.title{font-size:22px;font-weight:700;color:var(--accent-dark)}
nav{display:flex;justify-content:center;gap:26px;margin-top:14px}
nav a{color:var(--accent-dark);text-decoration:none;font-weight:600}
nav a:hover{text-decoration:underline}
section.card{background:#fff;border-radius:14px;padding:20px;margin-top:24px;box-shadow:0 8px 28px rgba(9,30,63,0.06)}
h2{color:var(--accent-dark);margin:0 0 10px 0}
.btn{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;display:inline-flex;gap:10px;align-items:center}
.btn:active{transform:translateY(1px)}
#webcam-wrap{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap}
#webcam-container{background:linear-gradient(180deg,#f8fdff,#ffffff);padding:12px;border-radius:10px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}
canvas{border-radius:8px;display:block}
#label-container div{font-size:16px;margin:6px 0}
.gauge-wrap{width:220px;height:140px;padding:6px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.gauge{width:190px;height:110px}
.gauge .label{font-weight:700;margin-top:6px}
.facts{width:280px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#f8ffff,#ffffff);box-shadow:0 6px 18px rgba(9,30,63,0.04)}
.fact-text{font-size:14px;min-height:56px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;transition:opacity .35s ease}
.droplet{position:fixed;bottom:-40px;background:linear-gradient(180deg,rgba(255,255,255,0.85),rgba(180,230,255,0.35));width:14px;height:20px;border-radius:50% 50% 60% 60%;filter:blur(.3px);opacity:.85;z-index:2;pointer-events:none}

/* ---------- BACKGROUND LAYERS ---------- */
.bg-viewport{
  position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0;
  display:block;
}

/* subtle animated caustics (soft light overlay) */
.caustics{
  position:absolute; inset:-10% -20% -10% -20%; z-index:0; mix-blend-mode:overlay;
  background-image:
    radial-gradient(circle at 20% 20%, rgba(255,255,255,0.12), transparent 12%),
    radial-gradient(circle at 80% 40%, rgba(255,255,255,0.08), transparent 10%),
    radial-gradient(circle at 60% 70%, rgba(255,255,255,0.06), transparent 12%);
  opacity:var(--caustics-opacity); transform:translateZ(0);
  animation:causticMove 18s linear infinite;
  filter: blur(10px) saturate(110%);
  will-change:transform;
}

/* fishes container */
.bg-fish-layer{
  position:absolute; inset:0; z-index:0; pointer-events:none; overflow:hidden;
}

/* bubbles container */
.bg-bubble-layer{ position:absolute; inset:0; z-index:0; pointer-events:none; overflow:visible; }

/* fish base style */
.fish{
  position:absolute; top:0; left:0; width:120px; height:auto; transform-origin:center; will-change:transform, opacity;
  backface-visibility:hidden; -webkit-backface-visibility:hidden;
  filter:drop-shadow(0 6px 10px rgba(5,36,52,0.06));
  opacity:.95;
  transform-style:preserve-3d;
}

/* tiny base SVG size controlled via inline style --scale variable */
.fish svg{ width:100%; height:auto; display:block; transform-origin:center center; }

/* loading overlay & ripple kept similar to your original */
#ripple{position:fixed;width:140px;height:140px;border-radius:50%;pointer-events:none;background:radial-gradient(circle at 40% 30%, rgba(255,255,255,0.75), rgba(179,224,255,0.18));mix-blend-mode:screen;opacity:.68;transform:translate(-50%,-50%) scale(.85);transition:transform .12s linear;z-index:3}
#loading{position:fixed;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(235,249,255,0.9));display:flex;align-items:center;justify-content:center;z-index:50;transition:opacity .45s ease}
.loader-card{background:linear-gradient(180deg,#fff,#f8feff);padding:28px;border-radius:14px;box-shadow:0 18px 40px rgba(9,30,63,0.08);display:flex;gap:18px;align-items:center}
.loading-droplets{display:flex;gap:8px}
.loading-droplets div{width:14px;height:18px;background:linear-gradient(180deg,#bfe9ff,#79c7ff);border-radius:50% 50% 60% 60%;animation:loadJump 0.8s infinite ease-in-out}
.loading-droplets div:nth-child(2){animation-delay:.12s}
.loading-droplets div:nth-child(3){animation-delay:.22s}
@keyframes loadJump{0%{transform:translateY(0)}50%{transform:translateY(-14px)}100%{transform:translateY(0)}}

/* small accessibility helper for focus outlines */
:focus{ outline:3px solid rgba(77,184,255,0.25); outline-offset:2px; }

/* bubble keyframe placeholder (JS injects actual keyframes once) */
</style>
</head>
<body>
  <!-- Background viewport contains caustics, fish and bubbles -->
  <div class="bg-viewport" aria-hidden="true">
    <div class="caustics" id="causticsLayer"></div>
    <div class="bg-fish-layer" id="fishLayer"></div>
    <div class="bg-bubble-layer" id="bubbleLayer"></div>
  </div>

  <!-- Ripple and a few droplets kept visually -->
  <div class="droplet" style="left:8%;animation:rise 8s linear infinite;"></div>
  <div class="droplet" style="left:18%;animation:rise 10s linear infinite;opacity:.9;"></div>
  <div class="droplet" style="left:36%;animation:rise 7s linear infinite;opacity:.85;"></div>
  <div class="droplet" style="left:58%;animation:rise 9s linear infinite;opacity:.8;"></div>
  <div class="droplet" style="left:76%;animation:rise 11s linear infinite;opacity:.9;"></div>

  <div id="ripple" aria-hidden="true"></div>

  <div id="loading" role="status" aria-live="polite">
    <div class="loader-card">
      <div>
        <div style="font-weight:700;color:var(--accent-dark);margin-bottom:8px">Preparing the water detector</div>
        <div style="font-size:13px;color:#345;opacity:.9">Loading model and camera â€” please allow camera access when prompted.</div>
      </div>
      <div style="width:22px"></div>
      <div class="loading-droplets" aria-hidden="true"><div></div><div></div><div></div></div>
    </div>
  </div>

  <div class="container" id="page-root">
    <header>
      <div class="logo" aria-hidden="true">ðŸ’§</div>
      <div>
        <div class="title">Clean Water Detector</div>
        <div style="font-size:12px;color:#2b5d82;margin-top:4px">Real-time water cleanliness classification (teachable machine)</div>
      </div>
    </header>

    <nav style="margin-top:14px">
      <a href="#about">About</a> &nbsp;Â·&nbsp;
      <a href="#instructions">Instructions</a> &nbsp;Â·&nbsp;
      <a href="#model">Model</a>
    </nav>

    <section class="card" id="about" style="display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <h2>About</h2>
        <p style="margin:8px 0 0 0">This demo uses a Teachable Machine image model to visually assess water samples. It is for demonstration and education only â€” not a certified lab test.</p>
      </div>
      <div class="facts" aria-live="polite">
        <div style="font-weight:700;margin-bottom:8px;color:var(--accent-dark);text-align:center">Water Knowledge</div>
        <div class="fact-text" id="fact-text">Loading tips & facts...</div>
        <div style="margin-top:8px;font-size:12px;text-align:center;color:#17607f">Tip: Use steady light and a plain background for best results.</div>
      </div>
    </section>

    <section class="card" id="instructions">
      <h2>Instructions</h2>
      <ul>
        <li>Click <button class="btn" id="start-btn-small">Start</button> to enable the camera.</li>
        <li>Hold the water sample steadily in view (good lighting helps).</li>
        <li>Click Stop to disable the camera when finished.</li>
      </ul>
    </section>

    <section class="card" id="model">
      <h2>Run the Model</h2>
      <div id="webcam-wrap" style="display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap">
        <div id="webcam-container">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="start-btn">Start</button>
            <button class="btn" id="stop-btn" style="background:#bbb;color:#102">Stop</button>
            <button class="btn" id="retry-btn" style="background:transparent;color:var(--accent-dark);border:1px solid rgba(3,62,107,0.06);">Retry Model</button>
          </div>
          <div id="canvas-holder" style="margin-top:12px"></div>
          <div id="label-container" style="margin-top:10px" aria-live="polite"></div>
        </div>

        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="gauge-wrap card" style="padding:12px;min-width:220px">
            <svg class="gauge" viewBox="0 0 200 100" aria-hidden="true">
              <path d="M 20 85 A 80 80 0 0 1 180 85" stroke="#ecf3fb" stroke-width="18" fill="none" stroke-linecap="round"/>
              <path id="gauge-arc" d="M 20 85 A 80 80 0 0 1 180 85" stroke="var(--clean-blue)" stroke-width="18" fill="none" stroke-linecap="round" stroke-dasharray="0 1000" transform="rotate(0 100 50)"/>
              <text id="gauge-percent" x="100" y="60" text-anchor="middle" font-size="22" font-weight="700" fill="#045c9c">--%</text>
            </svg>
            <div class="label" style="text-align:center;font-size:13px;color:#175d82">Water Quality</div>
          </div>

          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(9,30,63,0.04)">
              <div style="font-weight:700;color:var(--accent-dark);margin-bottom:6px">Model status</div>
              <div id="model-status" style="font-size:14px;color:#2b5d82">Waiting to start</div>
            </div>

            <div style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(9,30,63,0.04);min-width:220px">
              <div style="font-weight:700;color:var(--accent-dark);margin-bottom:6px">Quick tips</div>
              <ul style="margin:0;padding-left:18px;font-size:13px">
                <li>Use a plain background behind the sample.</li>
                <li>Keep camera steady and close to the water.</li>
                <li>Avoid strong reflections and glares.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- screen reader region -->
  <div id="sr-results" aria-live="polite" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden"></div>

  <!-- TensorFlow + Teachable Machine libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <!-- Main script: JS-controlled schooling fish + bubbles + model logic -->
  <script defer>
  (() => {
    'use strict';

    /* ------------------------------
       Configuration & cached DOM
       ------------------------------ */
    const MODEL_URL = './my_model/';
    const FACTS = [
      'ðŸ’§ Over 70% of Earth is water â€” but only a small fraction is drinkable.',
      'â™»ï¸ A single plastic bottle can take around 450 years to break down.',
      'ðŸŒ Conserving clean water is vital for health, food, and ecosystems.',
      'ðŸ”¬ This demo is for visual checks only â€” not a lab-grade test.',
      'ðŸ’¡ Tip: Clearer images + good lighting improve model predictions.'
    ];

    const startBtn = document.getElementById('start-btn');
    const startBtnSmall = document.getElementById('start-btn-small');
    const stopBtn = document.getElementById('stop-btn');
    const retryBtn = document.getElementById('retry-btn');
    const modelStatusEl = document.getElementById('model-status');
    const labelContainer = document.getElementById('label-container');
    const canvasHolder = document.getElementById('canvas-holder');
    const loadingEl = document.getElementById('loading');
    const factEl = document.getElementById('fact-text');
    const gaugeArc = document.getElementById('gauge-arc');
    const gaugePercent = document.getElementById('gauge-percent');
    const pageRoot = document.getElementById('page-root');
    const ripple = document.getElementById('ripple');
    const fishLayer = document.getElementById('fishLayer');
    const bubbleLayer = document.getElementById('bubbleLayer');
    const causticsLayer = document.getElementById('causticsLayer');
    const srResults = document.getElementById('sr-results');

    /* ------------------------------
       State
       ------------------------------ */
    let model = null, webcam = null, maxPredictions = 0, running = false;
    let animationFrameId = null, factIndex = 0, arcLength = 1;

    /* ------------------------------
       Utilities: UI helpers
       ------------------------------ */
    function showLoading(show=true, text){
      if(!loadingEl) return;
      loadingEl.style.display = show ? 'flex' : 'none';
      if(text) loadingEl.querySelector('.loader-card div').textContent = text;
    }
    function safeSetStatus(text){ modelStatusEl.textContent = text; }
    function setButtons(runningNow){
      if(startBtn) startBtn.disabled = runningNow;
      if(startBtnSmall) startBtnSmall.disabled = runningNow;
      if(stopBtn) stopBtn.disabled = !runningNow;
    }

    /* rotate facts */
    function rotateFacts(){
      if(!factEl) return;
      factEl.style.opacity = 0;
      setTimeout(()=>{ factEl.textContent = FACTS[factIndex]; factEl.style.opacity = 1; factIndex = (factIndex + 1) % FACTS.length; }, 300);
    }
    rotateFacts(); setInterval(rotateFacts, 10000);

    /* ripple follows pointer (low-cost) */
    document.addEventListener('pointermove', e => {
      ripple.style.left = e.clientX + 'px'; ripple.style.top = e.clientY + 'px';
    });

    /* ------------------------------
       JS-controlled schooling fish (B1 Calm School)
       - lightweight boids tuned for slow calm motion
       - uses transform for GPU acceleration
       ------------------------------ */

    // defensive layer checks
    if(!fishLayer || !bubbleLayer || !causticsLayer){
      console.warn('Background layers missing; background effects aborted.');
    }

    // small RNG helper
    function rand(min, max){ return Math.random() * (max - min) + min; }

    // fish configuration (tweak these constants to adjust behavior)
    const FISH_COUNT = Math.max(6, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fish-count')) || 20);
    const WIDTH = window.innerWidth;
    const HEIGHT = window.innerHeight;
    // schooling parameters
    const NEIGHBOR_RADIUS = 120; // px
    const MAX_SPEED = 0.5; // px per ms (very slow, calm)
    const MAX_FORCE = 0.0008; // steering magnitude
    const COHESION_WEIGHT = 0.0025;
    const ALIGNMENT_WEIGHT = 0.0020;
    const SEPARATION_WEIGHT = 0.0060;
    const TARGET_WEIGHT = 0.0005; // mild attraction to gentle wandering target

    // container for fish objects
    const fishList = [];

    // create unique fish SVG generator (unique gradient id per fish)
    function fishSVG(idSuffix, scale=1){
      const gid = 'fishGrad_' + idSuffix;
      // lighter, small fish shape
      return `
        <svg viewBox="0 0 220 120" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="${gid}" x1="0" x2="1">
              <stop offset="0" stop-color="#8fd8ff"/>
              <stop offset="1" stop-color="#5dbfff"/>
            </linearGradient>
            <linearGradient id="${gid}_tail" x1="0" x2="1">
              <stop offset="0" stop-color="#c6efff"/>
              <stop offset="1" stop-color="#9ad8ff"/>
            </linearGradient>
          </defs>
          <ellipse cx="100" cy="60" rx="${56*scale}" ry="${30*scale}" fill="url(#${gid})"/>
          <path d="M${157*scale} 60 L${200*scale} ${42*scale} L${200*scale} ${78*scale} Z" fill="url(#${gid}_tail)"/>
          <circle cx="${82*scale}" cy="${54*scale}" r="${5*scale}" fill="#052034"/>
          <circle cx="${80*scale}" cy="${52*scale}" r="${1.6*scale}" fill="#fff"/>
        </svg>
      `;
    }

    // Fish class holds physics state and DOM element
    class Fish {
      constructor(i){
        this.id = i;
        // position in px
        this.pos = {
          x: rand(0, window.innerWidth),
          y: rand(window.innerHeight * 0.08, window.innerHeight * 0.86)
        };
        // velocity in px/ms
        const ang = rand(0, Math.PI * 2);
        this.vel = { x: Math.cos(ang) * rand(0.02, 0.16), y: Math.sin(ang) * rand(0.01, 0.08) };
        this.acc = { x: 0, y: 0 };
        this.scale = rand(0.32, 0.82); // visual scale
        this.opacity = rand(0.62, 0.98);

        // target point for mild wandering (changes slowly)
        this.wanderTarget = { x: rand(0, window.innerWidth), y: rand(0, window.innerHeight) };
        this.wanderTimer = rand(3000, 11000);

        // create DOM node
        this.node = document.createElement('div');
        this.node.className = 'fish';
        this.node.style.width = (120 * this.scale) + 'px';
        this.node.style.opacity = this.opacity;
        // inject SVG with unique gradients
        this.node.innerHTML = fishSVG(i, 1);
        // initial transform
        this.applyTransform();

        // append
        fishLayer.appendChild(this.node);
      }

      // apply transform & rotation to DOM
      applyTransform(){
        // compute angle from velocity (face in direction of travel)
        const angle = Math.atan2(this.vel.y, this.vel.x) * (180 / Math.PI);
        // rotation around Y to flip when moving left (simulate subtle 3D)
        let rotateY = 0;
        if(this.vel.x < 0) rotateY = 180;
        // position using translate3d for GPU
        this.node.style.transform = `translate3d(${this.pos.x}px, ${this.pos.y}px, 0) rotateY(${rotateY}deg) rotate(${angle}deg) scale(${this.scale})`;
      }

      // limit magnitude
      limit(vec, max){
        const m = Math.hypot(vec.x, vec.y);
        if(m > max){
          vec.x = (vec.x / m) * max;
          vec.y = (vec.y / m) * max;
        }
      }

      // update physics using neighbor information
      update(dt, neighbors){
        // reset acceleration
        this.acc.x = 0; this.acc.y = 0;

        // cohesion: steer to average position of neighbors
        let coh = { x: 0, y: 0 }, cohCount = 0;
        // alignment: steer toward average velocity
        let ali = { x: 0, y: 0 }, aliCount = 0;
        // separation: avoid crowding
        let sep = { x: 0, y: 0 };

        for(const n of neighbors){
          if(n === this) continue;
          const dx = n.pos.x - this.pos.x;
          const dy = n.pos.y - this.pos.y;
          const dist = Math.hypot(dx, dy);
          if(dist < 1) continue;
          if(dist < NEIGHBOR_RADIUS){
            coh.x += n.pos.x; coh.y += n.pos.y; cohCount++;
            ali.x += n.vel.x; ali.y += n.vel.y; aliCount++;
            // separation: stronger when closer
            const s = (NEIGHBOR_RADIUS - dist) / NEIGHBOR_RADIUS;
            sep.x -= (dx / dist) * s;
            sep.y -= (dy / dist) * s;
          }
        }

        if(cohCount > 0){
          coh.x /= cohCount; coh.y /= cohCount;
          // vector toward cohesion center
          let steer = { x: coh.x - this.pos.x, y: coh.y - this.pos.y };
          this.limit(steer, MAX_FORCE * 1000);
          this.acc.x += steer.x * COHESION_WEIGHT;
          this.acc.y += steer.y * COHESION_WEIGHT;
        }

        if(aliCount > 0){
          ali.x /= aliCount; ali.y /= aliCount;
          // desired change toward alignment
          let steer = { x: ali.x - this.vel.x, y: ali.y - this.vel.y };
          this.limit(steer, MAX_FORCE * 1000);
          this.acc.x += steer.x * ALIGNMENT_WEIGHT;
          this.acc.y += steer.y * ALIGNMENT_WEIGHT;
        }

        // apply separation
        this.acc.x += sep.x * SEPARATION_WEIGHT;
        this.acc.y += sep.y * SEPARATION_WEIGHT;

        // mild wandering target force (keeps schools moving slowly across screen)
        this.wanderTimer -= dt;
        if(this.wanderTimer <= 0){
          this.wanderTarget.x = rand(0, window.innerWidth);
          this.wanderTarget.y = rand(window.innerHeight * 0.08, window.innerHeight * 0.86);
          this.wanderTimer = rand(4000, 12000);
        }
        const tx = this.wanderTarget.x - this.pos.x;
        const ty = this.wanderTarget.y - this.pos.y;
        const tdist = Math.hypot(tx, ty) || 1;
        this.acc.x += (tx / tdist) * TARGET_WEIGHT * 60;
        this.acc.y += (ty / tdist) * TARGET_WEIGHT * 60;

        // integrate velocity
        this.vel.x += this.acc.x * dt;
        this.vel.y += this.acc.y * dt;

        // limit speed
        this.limit(this.vel, MAX_SPEED);

        // integrate position
        this.pos.x += this.vel.x * dt;
        this.pos.y += this.vel.y * dt;

        // keep within vertical bounds (wrap horizontally)
        const margin = 8;
        const minY = window.innerHeight * 0.05;
        const maxY = window.innerHeight * 0.95;
        if(this.pos.y < minY) this.pos.y = minY + rand(0, 4);
        if(this.pos.y > maxY) this.pos.y = maxY - rand(0, 4);

        // horizontal wrap-around (gentle)
        if(this.pos.x < -80) this.pos.x = window.innerWidth + rand(20, 120);
        if(this.pos.x > window.innerWidth + 80) this.pos.x = -rand(20, 120);

        // slight vertical wobble for organic motion
        const wobble = Math.sin((performance.now() / 1000) + this.id) * 0.35;
        this.pos.y += wobble * (0.25 + this.scale * 0.6);

        // apply DOM transform
        this.applyTransform();
      }
    }

    // spawn fish list
    function spawnSchool(count){
      fishLayer.innerHTML = '';
      fishList.length = 0;
      for(let i=0;i<count;i++){
        const f = new Fish(i);
        fishList.push(f);
      }
    }

    // main fish update loop
    let lastTime = performance.now();
    function fishStep(now){
      const dt = Math.min(60, now - lastTime); // ms (cap to avoid spikes)
      lastTime = now;

      // neighbor queries - naive O(n^2); fine for ~30-60 fish
      for(const f of fishList){
        // build neighbor list
        const neighbors = [];
        for(const g of fishList){
          const dx = g.pos.x - f.pos.x, dy = g.pos.y - f.pos.y;
          if(Math.abs(dx) < NEIGHBOR_RADIUS && Math.abs(dy) < NEIGHBOR_RADIUS){
            const dist = Math.hypot(dx, dy);
            if(dist < NEIGHBOR_RADIUS) neighbors.push(g);
          }
        }
        f.update(dt, neighbors);
      }

      animationFrameId = requestAnimationFrame(fishStep);
    }

    /* ------------------------------
       Bubbles & Caustics (gentle)
       ------------------------------ */
    function spawnBubbles(count = Math.max(10, Math.floor(FISH_COUNT * 0.7))){
      bubbleLayer.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(let i=0;i<count;i++){
        const b = document.createElement('div');
        b.setAttribute('aria-hidden','true');
        const size = Math.round(rand(6,28));
        const left = rand(2, 96);
        const delay = rand(0, 12);
        const duration = rand(8, 26);
        b.style.position = 'absolute';
        b.style.left = left + 'vw';
        b.style.bottom = '-8vh';
        b.style.width = size + 'px';
        b.style.height = size + 'px';
        b.style.borderRadius = '50%';
        b.style.background = 'radial-gradient(circle at 35% 30%, rgba(255,255,255,0.9), rgba(180,230,255,0.35))';
        b.style.opacity = String(rand(0.04,0.22));
        b.style.filter = 'blur(0.6px)';
        b.style.animation = `bubbleRise ${duration}s linear ${delay}s infinite`;
        frag.appendChild(b);
      }
      bubbleLayer.appendChild(frag);

      if(!document.getElementById('bubbleRiseKeyframes')){
        const s = document.createElement('style'); s.id = 'bubbleRiseKeyframes';
        s.textContent = `
          @keyframes bubbleRise{
            0% { transform: translateY(0) scale(1); opacity: 0; }
            8% { opacity: 0.18; }
            60% { opacity: 0.12; }
            100% { transform: translateY(-120vh) scale(0.9); opacity: 0; }
          }
        `;
        document.head.appendChild(s);
      }
    }

    function startCaustics(){
      let t = 0;
      function step(){
        t += 0.0025;
        causticsLayer.style.transform = `translate3d(${Math.sin(t)*6}px, ${Math.cos(t*0.7)*8}px, 0) rotate(${Math.sin(t*0.3)*2}deg)`;
        requestAnimationFrame(step);
      }
      step();
    }

    /* ------------------------------
       Initialize background effects
       ------------------------------ */
    function initBackground(){
      const count = FISH_COUNT;
      spawnSchool(count);
      spawnBubbles(Math.max(10, Math.floor(count * 0.7)));
      startCaustics();
      // start fish update loop
      lastTime = performance.now();
      if(animationFrameId) cancelAnimationFrame(animationFrameId);
      animationFrameId = requestAnimationFrame(fishStep);
    }

    // start background on load
    initBackground();

    // expose respawn function for debugging/dev
    window.__respawnBackground = (n) => {
      const c = n || FISH_COUNT;
      spawnSchool(c);
      spawnBubbles(Math.max(10, Math.floor(c * 0.7)));
    };

    // handle resize: adjust bounds and gently reposition fish to stay in view
    window.addEventListener('resize', () => {
      for(const f of fishList){
        f.pos.x = Math.min(window.innerWidth - 10, f.pos.x);
        f.pos.y = Math.min(window.innerHeight - 10, Math.max(5, f.pos.y));
      }
    });

    /* ------------------------------
       Model & webcam code (kept & lightly cleaned)
       ------------------------------ */
    let animationLoopId = null;
    async function loadModel(){
      showLoading(true);
      safeSetStatus('Loading model...');
      try{
        model = await tmImage.load(MODEL_URL + 'model.json', MODEL_URL + 'metadata.json');
        maxPredictions = model.getTotalClasses();
        safeSetStatus('Model loaded');
        labelContainer.innerHTML = '';
        for(let i=0;i<maxPredictions;i++){ const d = document.createElement('div'); d.textContent = ''; labelContainer.appendChild(d); }
        arcLength = gaugeArc.getTotalLength ? gaugeArc.getTotalLength() : 250;
        hideLoadingAfter(300);
        return true;
      }catch(err){
        console.error('Model load failed', err);
        safeSetStatus('Failed to load model');
        hideLoadingAfter(450);
        return false;
      }
    }
    function hideLoadingAfter(ms=500){ setTimeout(()=> showLoading(false), ms); }

    async function startCameraAndRun(){
      try{
        if(!model){ const ok = await loadModel(); if(!ok) return; }
        showLoading(true);
        safeSetStatus('Initializing camera...');
        webcam = new tmImage.Webcam(320,240,true);
        await webcam.setup();
        await webcam.play();
        canvasHolder.innerHTML = '';
        canvasHolder.appendChild(webcam.canvas);

        running = true; setButtons(true);
        safeSetStatus('Running');
        hideLoadingAfter(300);
        animationLoopId = requestAnimationFrame(loop);
      }catch(err){
        console.error('Camera error', err);
        safeSetStatus('Camera unavailable or permission denied. Please allow camera and retry.');
        showLoading(false);
        setButtons(false);
        if(webcam && webcam.stop) webcam.stop();
      }
    }

    function stopCamera(){
      running = false;
      if(animationLoopId) cancelAnimationFrame(animationLoopId);
      if(webcam && webcam.stop) webcam.stop();
      webcam = null;
      canvasHolder.innerHTML = '';
      setButtons(false);
      safeSetStatus('Camera stopped');
    }

    window.addEventListener('beforeunload', () => { if(webcam && webcam.stop) webcam.stop(); });

    function extractCleanScore(predictions){
      const lower = predictions.map(p => p.className.toLowerCase());
      const findIdx = (rx) => lower.findIndex(n => rx.test(n));
      const cleanIdx = findIdx(/clean|clear|pure|s
