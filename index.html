<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clean Water Detector â€” Enhanced (Calm & Clean)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#eaf9ff; --accent:#4db8ff; --accent-dark:#045c9c; --text:#033e6b;
  --clean-blue:#3fb0ff; --dirty-red:#ff6b6b; --maybe-yellow:#f0c419;
  --fish-count:28; /* default number of fish in background */
  --caustics-opacity:0.18;
}

/* Reset & layout */
html,body{height:100%;margin:0;background:var(--bg);font-family:'Inter',sans-serif;color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:980px;margin:32px auto;padding:0 20px;position:relative;z-index:6}
header{display:flex;align-items:center;gap:12px;justify-content:center;padding:28px 12px;background:rgba(255,255,255,0.92);border-radius:12px;box-shadow:0 6px 18px rgba(9,30,63,0.06);position:relative;z-index:6}
.logo{width:62px;height:62px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#bfe9ff);display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 6px 14px rgba(0,0,0,0.06)}
.title{font-size:22px;font-weight:700;color:var(--accent-dark)}
nav{display:flex;justify-content:center;gap:26px;margin-top:14px}
nav a{color:var(--accent-dark);text-decoration:none;font-weight:600}
nav a:hover{text-decoration:underline}
section.card{background:#fff;border-radius:14px;padding:20px;margin-top:24px;box-shadow:0 8px 28px rgba(9,30,63,0.06)}
h2{color:var(--accent-dark);margin:0 0 10px 0}
.btn{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;display:inline-flex;gap:10px;align-items:center}
.btn:active{transform:translateY(1px)}
#webcam-wrap{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap}
#webcam-container{background:linear-gradient(180deg,#f8fdff,#ffffff);padding:12px;border-radius:10px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}
canvas{border-radius:8px;display:block}
#label-container div{font-size:16px;margin:6px 0}
.gauge-wrap{width:220px;height:140px;padding:6px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.gauge{width:190px;height:110px}
.gauge .label{font-weight:700;margin-top:6px}
.facts{width:280px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#f8ffff,#ffffff);box-shadow:0 6px 18px rgba(9,30,63,0.04)}
.fact-text{font-size:14px;min-height:56px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;transition:opacity .35s ease}
.droplet{position:fixed;bottom:-40px;background:linear-gradient(180deg,rgba(255,255,255,0.85),rgba(180,230,255,0.35));width:14px;height:20px;border-radius:50% 50% 60% 60%;filter:blur(.3px);opacity:.85;z-index:2;pointer-events:none}

/* ---------- BACKGROUND LAYERS ---------- */
.bg-viewport{
  position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0;
  display:block;
}

/* subtle animated caustics (soft light overlay) */
.caustics{
  position:absolute; inset:-10% -20% -10% -20%; z-index:0; mix-blend-mode:overlay;
  background-image:
    radial-gradient(circle at 20% 20%, rgba(255,255,255,0.12), transparent 12%),
    radial-gradient(circle at 80% 40%, rgba(255,255,255,0.08), transparent 10%),
    radial-gradient(circle at 60% 70%, rgba(255,255,255,0.06), transparent 12%);
  opacity:var(--caustics-opacity); transform:translateZ(0);
  animation:causticMove 18s linear infinite;
  filter: blur(10px) saturate(110%);
  will-change:transform;
}

/* fishes container */
.bg-fish-layer{
  position:absolute; inset:0; z-index:0; pointer-events:none; overflow:hidden;
}

/* bubbles container */
.bg-bubble-layer{ position:absolute; inset:0; z-index:0; pointer-events:none; overflow:visible; }

/* fish base style */
.fish{
  position:absolute; top:0; left:0; width:120px; height:auto; transform-origin:center; will-change:transform, opacity;
  backface-visibility:hidden; -webkit-backface-visibility:hidden;
  filter:drop-shadow(0 6px 10px rgba(5,36,52,0.06));
  opacity:.95;
}

/* tiny base SVG size controlled via inline style --scale variable */
.fish svg{ width:100%; height:auto; display:block; transform-origin:center center; }

/* horizontal swim L->R animation (uses CSS variables set inline) */
@keyframes swimLR {
  0% { transform: translateX(-18vw) translateY(var(--y-offset)) rotateY(0deg) scale(var(--scale)); }
  50% { transform: translateX(52vw) translateY(calc(var(--y-offset) + var(--bob))) rotateY(0deg) scale(var(--scale)); }
  100% { transform: translateX(122vw) translateY(var(--y-offset)) rotateY(0deg) scale(var(--scale)); }
}

/* horizontal swim R->L (flip via rotateY 180deg so fish faces left; no teleport) */
@keyframes swimRL {
  0% { transform: translateX(122vw) translateY(var(--y-offset)) rotateY(180deg) scale(var(--scale)); }
  50% { transform: translateX(52vw) translateY(calc(var(--y-offset) + var(--bob))) rotateY(180deg) scale(var(--scale)); }
  100% { transform: translateX(-18vw) translateY(var(--y-offset)) rotateY(180deg) scale(var(--scale)); }
}

/* gentle vertical bob is baked into the keyframes as --bob (see JS) */

/* we use custom properties for duration and delay so each fish varies */
.fish.anim-lr{ animation: swimLR var(--duration)s linear var(--delay)s infinite; }
.fish.anim-rl{ animation: swimRL var(--duration)s linear var(--delay)s infinite; }

/* reduce motion on small screens a bit */
@media (max-width:880px){
  :root{ --fish-count:18; --caustics-opacity:0.12; }
  .caustics{ animation-duration:26s; }
}

/* loading overlay & ripple kept similar to your original */
#ripple{position:fixed;width:140px;height:140px;border-radius:50%;pointer-events:none;background:radial-gradient(circle at 40% 30%, rgba(255,255,255,0.75), rgba(179,224,255,0.18));mix-blend-mode:screen;opacity:.68;transform:translate(-50%,-50%) scale(.85);transition:transform .12s linear;z-index:3}
#loading{position:fixed;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(235,249,255,0.9));display:flex;align-items:center;justify-content:center;z-index:50;transition:opacity .45s ease}
.loader-card{background:linear-gradient(180deg,#fff,#f8feff);padding:28px;border-radius:14px;box-shadow:0 18px 40px rgba(9,30,63,0.08);display:flex;gap:18px;align-items:center}
.loading-droplets{display:flex;gap:8px}
.loading-droplets div{width:14px;height:18px;background:linear-gradient(180deg,#bfe9ff,#79c7ff);border-radius:50% 50% 60% 60%;animation:loadJump 0.8s infinite ease-in-out}
.loading-droplets div:nth-child(2){animation-delay:.12s}
.loading-droplets div:nth-child(3){animation-delay:.22s}
@keyframes loadJump{0%{transform:translateY(0)}50%{transform:translateY(-14px)}100%{transform:translateY(0)}}

/* small accessibility helper for focus outlines */
:focus{ outline:3px solid rgba(77,184,255,0.25); outline-offset:2px; }

/* performance hint: keep only transform/opacity animations where possible */
</style>
</head>
<body>
  <!-- Background viewport contains caustics, fish and bubbles -->
  <div class="bg-viewport" aria-hidden="true">
    <div class="caustics" id="causticsLayer"></div>
    <div class="bg-fish-layer" id="fishLayer"></div>
    <div class="bg-bubble-layer" id="bubbleLayer"></div>
  </div>

  <!-- Ripple and a few droplets kept visually -->
  <div class="droplet" style="left:8%;animation:rise 8s linear infinite;"></div>
  <div class="droplet" style="left:18%;animation:rise 10s linear infinite;opacity:.9;"></div>
  <div class="droplet" style="left:36%;animation:rise 7s linear infinite;opacity:.85;"></div>
  <div class="droplet" style="left:58%;animation:rise 9s linear infinite;opacity:.8;"></div>
  <div class="droplet" style="left:76%;animation:rise 11s linear infinite;opacity:.9;"></div>

  <div id="ripple" aria-hidden="true"></div>

  <div id="loading" role="status" aria-live="polite">
    <div class="loader-card">
      <div>
        <div style="font-weight:700;color:var(--accent-dark);margin-bottom:8px">Preparing the water detector</div>
        <div style="font-size:13px;color:#345;opacity:.9">Loading model and camera â€” please allow camera access when prompted.</div>
      </div>
      <div style="width:22px"></div>
      <div class="loading-droplets" aria-hidden="true"><div></div><div></div><div></div></div>
    </div>
  </div>

  <div class="container" id="page-root">
    <header>
      <div class="logo" aria-hidden="true">ðŸ’§</div>
      <div>
        <div class="title">Clean Water Detector</div>
        <div style="font-size:12px;color:#2b5d82;margin-top:4px">Real-time water cleanliness classification (teachable machine)</div>
      </div>
    </header>

    <nav style="margin-top:14px">
      <a href="#about">About</a> &nbsp;Â·&nbsp;
      <a href="#instructions">Instructions</a> &nbsp;Â·&nbsp;
      <a href="#model">Model</a>
    </nav>

    <section class="card" id="about" style="display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <h2>About</h2>
        <p style="margin:8px 0 0 0">This demo uses a Teachable Machine image model to visually assess water samples. It is for demonstration and education only â€” not a certified lab test.</p>
      </div>
      <div class="facts" aria-live="polite">
        <div style="font-weight:700;margin-bottom:8px;color:var(--accent-dark);text-align:center">Water Knowledge</div>
        <div class="fact-text" id="fact-text">Loading tips & facts...</div>
        <div style="margin-top:8px;font-size:12px;text-align:center;color:#17607f">Tip: Use steady light and a plain background for best results.</div>
      </div>
    </section>

    <section class="card" id="instructions">
      <h2>Instructions</h2>
      <ul>
        <li>Click <button class="btn" id="start-btn-small">Start</button> to enable the camera.</li>
        <li>Hold the water sample steadily in view (good lighting helps).</li>
        <li>Click Stop to disable the camera when finished.</li>
      </ul>
    </section>

    <section class="card" id="model">
      <h2>Run the Model</h2>
      <div id="webcam-wrap" style="display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap">
        <div id="webcam-container">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="start-btn">Start</button>
            <button class="btn" id="stop-btn" style="background:#bbb;color:#102">Stop</button>
            <button class="btn" id="retry-btn" style="background:transparent;color:var(--accent-dark);border:1px solid rgba(3,62,107,0.06);">Retry Model</button>
          </div>
          <div id="canvas-holder" style="margin-top:12px"></div>
          <div id="label-container" style="margin-top:10px" aria-live="polite"></div>
        </div>

        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="gauge-wrap card" style="padding:12px;min-width:220px">
            <svg class="gauge" viewBox="0 0 200 100" aria-hidden="true">
              <path d="M 20 85 A 80 80 0 0 1 180 85" stroke="#ecf3fb" stroke-width="18" fill="none" stroke-linecap="round"/>
              <path id="gauge-arc" d="M 20 85 A 80 80 0 0 1 180 85" stroke="var(--clean-blue)" stroke-width="18" fill="none" stroke-linecap="round" stroke-dasharray="0 1000" transform="rotate(0 100 50)"/>
              <text id="gauge-percent" x="100" y="60" text-anchor="middle" font-size="22" font-weight="700" fill="#045c9c">--%</text>
            </svg>
            <div class="label" style="text-align:center;font-size:13px;color:#175d82">Water Quality</div>
          </div>

          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(9,30,63,0.04)">
              <div style="font-weight:700;color:var(--accent-dark);margin-bottom:6px">Model status</div>
              <div id="model-status" style="font-size:14px;color:#2b5d82">Waiting to start</div>
            </div>

            <div style="background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(9,30,63,0.04);min-width:220px">
              <div style="font-weight:700;color:var(--accent-dark);margin-bottom:6px">Quick tips</div>
              <ul style="margin:0;padding-left:18px;font-size:13px">
                <li>Use a plain background behind the sample.</li>
                <li>Keep camera steady and close to the water.</li>
                <li>Avoid strong reflections and glares.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- screen reader region -->
  <div id="sr-results" aria-live="polite" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden"></div>

  <!-- TensorFlow + Teachable Machine libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <!-- Main script: fish generator + bubbles + model logic -->
  <script defer>
  (() => {
    'use strict';

    /* ------------------------------
       Configuration & cached DOM
       ------------------------------ */
    const MODEL_URL = './my_model/';
    const FACTS = [
      'ðŸ’§ Over 70% of Earth is water â€” but only a small fraction is drinkable.',
      'â™»ï¸ A single plastic bottle can take around 450 years to break down.',
      'ðŸŒ Conserving clean water is vital for health, food, and ecosystems.',
      'ðŸ”¬ This demo is for visual checks only â€” not a lab-grade test.',
      'ðŸ’¡ Tip: Clearer images + good lighting improve model predictions.'
    ];

    const startBtn = document.getElementById('start-btn');
    const startBtnSmall = document.getElementById('start-btn-small');
    const stopBtn = document.getElementById('stop-btn');
    const retryBtn = document.getElementById('retry-btn');
    const modelStatusEl = document.getElementById('model-status');
    const labelContainer = document.getElementById('label-container');
    const canvasHolder = document.getElementById('canvas-holder');
    const loadingEl = document.getElementById('loading');
    const factEl = document.getElementById('fact-text');
    const gaugeArc = document.getElementById('gauge-arc');
    const gaugePercent = document.getElementById('gauge-percent');
    const pageRoot = document.getElementById('page-root');
    const ripple = document.getElementById('ripple');
    const fishLayer = document.getElementById('fishLayer');
    const bubbleLayer = document.getElementById('bubbleLayer');
    const causticsLayer = document.getElementById('causticsLayer');
    const srResults = document.getElementById('sr-results');

    /* ------------------------------
       State
       ------------------------------ */
    let model = null, webcam = null, maxPredictions = 0, running = false;
    let animationFrameId = null, factIndex = 0, arcLength = 1;

    /* ------------------------------
       Utilities: UI helpers
       ------------------------------ */
    function showLoading(show=true, text){
      if(!loadingEl) return;
      loadingEl.style.display = show ? 'flex' : 'none';
      if(text) loadingEl.querySelector('.loader-card div').textContent = text;
    }
    function safeSetStatus(text){ modelStatusEl.textContent = text; }
    function setButtons(runningNow){
      if(startBtn) startBtn.disabled = runningNow;
      if(startBtnSmall) startBtnSmall.disabled = runningNow;
      if(stopBtn) stopBtn.disabled = !runningNow;
    }

    /* rotate facts */
    function rotateFacts(){
      factEl.style.opacity = 0;
      setTimeout(()=>{ factEl.textContent = FACTS[factIndex]; factEl.style.opacity = 1; factIndex = (factIndex + 1) % FACTS.length; }, 300);
    }
    rotateFacts(); setInterval(rotateFacts, 10000);

    /* ripple follows pointer (low-cost) */
    document.addEventListener('pointermove', e => {
      ripple.style.left = e.clientX + 'px'; ripple.style.top = e.clientY + 'px';
    });

    /* ------------------------------
       Fish generator (Calm & Clean)
       - creates many small fish with CSS animations
       - uses CSS variables for per-fish randomness
       ------------------------------ */
    function rand(min, max){ return Math.random() * (max - min) + min; }
    function makeFishSVG(){
      // inline simple fish svg to reuse
      return `
        <svg viewBox="0 0 220 120" aria-hidden="true" focusable="false" role="img">
          <defs>
            <linearGradient id="gA" x1="0" x2="1">
              <stop offset="0" stop-color="#7fd1ff"/>
              <stop offset="1" stop-color="#55b6ff"/>
            </linearGradient>
          </defs>
          <ellipse cx="100" cy="60" rx="56" ry="30" fill="url(#gA)"/>
          <path d="M157 60 L200 42 L200 78 Z" fill="#9fdcff"/>
          <circle cx="82" cy="54" r="5" fill="#052034"/>
          <circle cx="80" cy="52" r="1.9" fill="#fff"/>
        </svg>
      `;
    }

    function spawnFish(count = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fish-count')) || 20){
      fishLayer.innerHTML = ''; // clear
      const frag = document.createDocumentFragment();
      for(let i=0;i<count;i++){
        const el = document.createElement('div');
        el.className = 'fish';
        // direction: L->R or R->L
        const dir = (Math.random() > 0.5) ? 'lr' : 'rl';
        el.classList.add(dir === 'lr' ? 'anim-lr' : 'anim-rl');

        // randomize parameters (duration seconds, delay sec, vertical offset px, bob px, scale)
        const duration = rand(10, 28); // slower gentle movement
        const delay = rand(-duration, 6); // negative delays make layer already in-motion
        const topPct = rand(6, 86); // avoid extreme edges
        const scale = rand(0.32, 0.78); // small fish
        const opacity = rand(0.65, 0.98);
        const bob = rand(6, 18); // vertical bob amplitude in px
        // set CSS vars to control animation
        el.style.setProperty('--duration', duration);
        el.style.setProperty('--delay', delay);
        el.style.setProperty('--y-offset', topPct + 'vh');
        el.style.setProperty('--bob', bob + 'px');
        el.style.setProperty('--scale', scale);
        el.style.opacity = opacity;

        // slight horizontal offset to vary depth illusion (transform translateX controlled by keyframes)
        // innerHTML fish svg
        el.innerHTML = makeFishSVG();
        frag.appendChild(el);
      }
      fishLayer.appendChild(frag);
    }

    /* bubbles: gentle rising bubbles for background */
    function spawnBubbles(count = 22){
      bubbleLayer.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(let i=0;i<count;i++){
        const b = document.createElement('div');
        b.setAttribute('aria-hidden','true');
        // random bubble element: use simple circle via CSS
        const size = Math.round(rand(6,28));
        const left = rand(2, 96);
        const delay = rand(0, 12);
        const duration = rand(6, 24);
        b.style.position = 'absolute';
        b.style.left = left + 'vw';
        b.style.bottom = '-6vh';
        b.style.width = size + 'px';
        b.style.height = size + 'px';
        b.style.borderRadius = '50%';
        b.style.background = 'radial-gradient(circle at 35% 30%, rgba(255,255,255,0.9), rgba(180,230,255,0.35))';
        b.style.opacity = String(rand(0.06,0.28));
        b.style.filter = 'blur(0.6px)';
        b.style.transform = `translateY(0)`;
        b.style.transition = 'none';
        // animate via CSS using inline keyframes injection to avoid too many global keyframes
        b.style.animation = `bubbleRise ${duration}s linear ${delay}s infinite`;
        frag.appendChild(b);
      }
      bubbleLayer.appendChild(frag);

      // ensure a single keyframe exists for bubbleRise (once)
      if(!document.getElementById('bubbleRiseKeyframes')){
        const s = document.createElement('style'); s.id = 'bubbleRiseKeyframes';
        s.textContent = `
          @keyframes bubbleRise{
            0% { transform: translateY(0) scale(1); opacity: 0; }
            8% { opacity: 0.18; }
            60% { opacity: 0.12; }
            100% { transform: translateY(-120vh) scale(0.9); opacity: 0; }
          }
        `;
        document.head.appendChild(s);
      }
    }

    /* caustics subtle animation (tweak background positions) */
    function startCaustics(){
      // gently shift the caustics background over time for a moving-light feeling
      let t = 0;
      function step(){
        t += 0.0025;
        causticsLayer.style.transform = `translate3d(${Math.sin(t)*6}px, ${Math.cos(t*0.7)*8}px, 0) rotate(${Math.sin(t*0.3)*2}deg)`;
        requestAnimationFrame(step);
      }
      step();
    }

    /* ------------------------------
       Model & webcam code (kept & lightly cleaned)
       ------------------------------ */
    let animationLoopId = null;
    async function loadModel(){
      showLoading(true);
      safeSetStatus('Loading model...');
      try{
        model = await tmImage.load(MODEL_URL + 'model.json', MODEL_URL + 'metadata.json');
        maxPredictions = model.getTotalClasses();
        safeSetStatus('Model loaded');
        labelContainer.innerHTML = '';
        for(let i=0;i<maxPredictions;i++){ const d = document.createElement('div'); d.textContent = ''; labelContainer.appendChild(d); }
        arcLength = gaugeArc.getTotalLength ? gaugeArc.getTotalLength() : 250;
        hideLoadingAfter(300);
        return true;
      }catch(err){
        console.error('Model load failed', err);
        safeSetStatus('Failed to load model');
        hideLoadingAfter(450);
        return false;
      }
    }
    function hideLoadingAfter(ms=500){ setTimeout(()=> showLoading(false), ms); }

    async function startCameraAndRun(){
      try{
        if(!model){ const ok = await loadModel(); if(!ok) return; }
        showLoading(true);
        safeSetStatus('Initializing camera...');
        webcam = new tmImage.Webcam(320,240,true);
        await webcam.setup();
        await webcam.play();
        canvasHolder.innerHTML = '';
        canvasHolder.appendChild(webcam.canvas);

        running = true; setButtons(true);
        safeSetStatus('Running');
        hideLoadingAfter(300);
        animationLoopId = requestAnimationFrame(loop);
      }catch(err){
        console.error('Camera error', err);
        safeSetStatus('Camera unavailable or permission denied. Please allow camera and retry.');
        showLoading(false);
        setButtons(false);
        if(webcam && webcam.stop) webcam.stop();
      }
    }

    function stopCamera(){
      running = false;
      if(animationLoopId) cancelAnimationFrame(animationLoopId);
      if(webcam && webcam.stop) webcam.stop();
      webcam = null;
      canvasHolder.innerHTML = '';
      setButtons(false);
      safeSetStatus('Camera stopped');
    }

    window.addEventListener('beforeunload', () => { if(webcam && webcam.stop) webcam.stop(); });

    function extractCleanScore(predictions){
      const lower = predictions.map(p => p.className.toLowerCase());
      const findIdx = (rx) => lower.findIndex(n => rx.test(n));
      const cleanIdx = findIdx(/clean|clear|pure|safe/);
      if(cleanIdx >= 0) return predictions[cleanIdx].probability;
      const dirtyIdx = findIdx(/dirty|contamin|pollut|turbid|unclean/);
      if(dirtyIdx >= 0) return 1 - predictions[dirtyIdx].probability;
      if(predictions.length === 3) return predictions[0].probability;
      const maxp = predictions.reduce((a,b)=> a.probability>=b.probability?a:b);
      return maxp.probability;
    }

    function updateGauge(score){
      const pct = Math.round(score * 100);
      gaugePercent.textContent = pct + '%';
      const dash = (score * arcLength);
      gaugeArc.setAttribute('stroke-dasharray', `${dash} ${arcLength}`);
      let color = 'var(--clean-blue)';
      if(score >= 0.8) color = 'var(--clean-blue)'; else if(score >= 0.4) color = 'var(--maybe-yellow)'; else color = 'var(--dirty-red)';
      gaugeArc.setAttribute('stroke', color);
    }

    function setGlow(on){
      if(on){ pageRoot.classList.add('glow-on'); setTimeout(()=> pageRoot.classList.remove('glow-on'), 700); }
      else pageRoot.classList.remove('glow-on');
    }

    async function predictOnce(){
      if(!model || !webcam) return;
      try{
        const predictions = await model.predict(webcam.canvas);
        predictions.forEach((p,i) => {
          const node = labelContainer.childNodes[i];
          if(node) node.textContent = `${p.className}: ${p.probability.toFixed(2)}`;
        });

        const best = predictions.reduce((a,b)=> a.probability>=b.probability?a:b);
        const score = extractCleanScore(predictions);
        updateGauge(score);
        safeSetStatus(`Top: ${best.className} (${best.probability.toFixed(2)})`);
        srResults.textContent = `Prediction: ${best.className}, confidence ${Math.round(best.probability*100)} percent`;
        try{ localStorage.setItem('lastResult', best.className); }catch(e){}
        if(score >= 0.8) setGlow(true);
        const scale = 0.85 + score * 0.6;
        ripple.style.transform = `translate(-50%,-50%) scale(${scale})`;
      }catch(err){ console.error('Predict error', err); }
    }

    function loop(){
      if(!running) return;
      try{ webcam.update(); predictOnce(); }catch(e){ console.error(e); }
      animationLoopId = requestAnimationFrame(loop);
    }

    /* ------------------------------
       Wiring UI events
       ------------------------------ */
    [startBtn, startBtnSmall].forEach(b => { if(b) b.addEventListener('click', () => startCameraAndRun()); });
    stopBtn && stopBtn.addEventListener('click', stopCamera);
    retryBtn && retryBtn.addEventListener('click', async ()=>{ safeSetStatus('Retrying model...'); await loadModel(); });

    // sensible initial state
    setButtons(false);
    showLoading(true);
    loadModel().then(()=> hideLoadingAfter(200)).catch(()=> hideLoadingAfter(200));
    try{ const lastResult = localStorage.getItem('lastResult'); if(lastResult) modelStatusEl.textContent = 'Last: ' + lastResult; }catch(e){}

    setTimeout(()=>{ if(loadingEl && loadingEl.style.display !== 'none' && !model) loadingEl.querySelector('.loader-card div').textContent = 'Click Start to try again.'; },15000);

    /* ------------------------------
       Kickoff background effects
       ------------------------------ */
    function initBackground(){
      const count = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fish-count')) || 20;
      spawnFish(count);
      spawnBubbles(Math.max(12, Math.floor(count * 0.7)));
      startCaustics();
    }

    // on DOM ready (deferred script should be okay)
    initBackground();

    // allow a simple API to respawn fish (useful while developing)
    window.__respawnBackground = () => { initBackground(); };

  })();
  </script>

</body>
</html>
